<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nosdu">
<link rel="apple-touch-icon" href="icon-192.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nosdu Controle Financeiro</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #0f172a;
    --bg-secondary: #020617;
    --bg-card: #1e293b;
    --text-primary: #e5e7eb;
    --text-secondary: #94a3b8;
    --accent-blue: #2563eb;
    --accent-green: #22c55e;
    --accent-red: #ef4444;
    --accent-orange: #d97706;
    --border: #334155;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    padding-bottom: 80px;
}

.preview-container {
    max-width: 480px;
    margin: 0 auto;
    background: var(--bg-primary);
    min-height: 100vh;
    position: relative;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
}

header {
    background: var(--bg-secondary);
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
}

header h1 {
    font-size: 22px;
    margin-bottom: 5px;
    background: linear-gradient(90deg, var(--accent-blue), #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

header span {
    font-size: 12px;
    color: var(--text-secondary);
}

.install-btn {
    display: block !important;
    margin-top: 10px;
    padding: 10px 20px;
    background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.install-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}

.install-btn:active {
    transform: translateY(0);
}

.permission-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.permission-overlay.active {
    display: flex;
}

.permission-modal {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    border: 1px solid var(--border);
    animation: slideUp 0.3s ease;
}

.permission-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
    border-radius: 20px;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
}

.permission-title {
    font-size: 20px;
    text-align: center;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.permission-text {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 25px;
    line-height: 1.6;
}

.permission-features {
    background: var(--bg-card);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 25px;
}

.permission-feature {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.permission-feature:last-child {
    margin-bottom: 0;
}

.permission-feature i {
    color: var(--accent-green);
    font-style: normal;
}

.permission-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.permission-btn {
    padding: 15px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.permission-btn.primary {
    background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
    color: white;
    font-weight: 600;
}

.permission-btn.secondary {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
}

.permission-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(37, 99, 235, 0.3);
}

main {
    padding: 15px;
}

section {
    display: none;
}

section.active {
    display: block;
}

.card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
}

.card-title {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

input, select {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 14px;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--accent-blue);
}

.descricao-field {
    display: none;
    animation: fadeIn 0.3s ease;
}

.descricao-field.visible {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

button.action {
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

button.action:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(37, 99, 235, 0.3);
}

button.action:disabled {
    background: var(--border);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-card);
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid transparent;
}

.list-item.entrada {
    border-left-color: var(--accent-green);
}

.list-item.saida {
    border-left-color: var(--accent-red);
}

.list-item-info {
    flex: 1;
}

.list-item-value {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
}

.list-item-value.positive {
    color: var(--accent-green);
}

.list-item-value.negative {
    color: var(--accent-red);
}

.list-item-meta {
    font-size: 11px;
    color: var(--text-secondary);
}

.list-item-desc {
    font-size: 11px;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 2px;
}

.list-item-delete {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: rgba(239, 68, 68, 0.2);
    color: var(--accent-red);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.list-item-delete:hover {
    background: var(--accent-red);
    color: white;
}

.chart-container {
    margin-top: 15px;
}

.chart-bar {
    margin-bottom: 12px;
}

.chart-bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    margin-bottom: 6px;
}

.chart-bar-track {
    height: 8px;
    background: var(--bg-card);
    border-radius: 4px;
    overflow: hidden;
}

.chart-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
}

.chart-bar-fill.entrada {
    background: linear-gradient(90deg, var(--accent-green), #10b981);
}

.chart-bar-fill.saida {
    background: linear-gradient(90deg, var(--accent-red), #f97316);
}

.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border);
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -17px;
    top: 4px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent-green);
    border: 2px solid var(--bg-primary);
}

.timeline-item.saida::before {
    background: var(--accent-red);
}

.timeline-content {
    background: var(--bg-card);
    padding: 12px;
    border-radius: 8px;
}

.timeline-time {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.timeline-value {
    font-size: 14px;
    font-weight: 600;
}

.timeline-desc {
    font-size: 11px;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 4px;
}

nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 10px;
    z-index: 100;
}

nav button {
    flex: 1;
    background: none;
    border: none;
    color: var(--text-secondary);
    padding: 10px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

nav button.active {
    background: rgba(37, 99, 235, 0.2);
    color: var(--accent-blue);
}

nav button span {
    font-size: 20px;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent-green);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 2000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideDown 0.3s ease;
    max-width: 90%;
    text-align: center;
}

.notification.warning {
    background: var(--accent-orange);
}

.notification.error {
    background: var(--accent-red);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translate(-50%, -100%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, 0);
    }
}

.backup-section {
    background: var(--bg-card);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
}

.backup-btn {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
}

.backup-btn:hover {
    border-color: var(--accent-blue);
}

.confirm-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 3000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.confirm-modal.active {
    display: flex;
}

.confirm-box {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 25px;
    max-width: 350px;
    width: 100%;
    border: 1px solid var(--accent-red);
    animation: slideUp 0.3s ease;
}

.confirm-title {
    font-size: 18px;
    color: var(--accent-red);
    margin-bottom: 15px;
    text-align: center;
}

.confirm-text {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    text-align: center;
    line-height: 1.6;
}

.confirm-input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 16px;
    text-align: center;
    margin-bottom: 15px;
    text-transform: uppercase;
}

.confirm-input:focus {
    outline: none;
    border-color: var(--accent-red);
}

.confirm-buttons {
    display: flex;
    gap: 10px;
}

.confirm-btn {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.confirm-btn.danger {
    background: var(--accent-red);
    color: white;
    font-weight: 600;
}

.confirm-btn.secondary {
    background: var(--bg-card);
    color: var(--text-secondary);
    border: 1px solid var(--border);
}

.confirm-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.mes-item {
    background: var(--bg-card);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 3px solid var(--accent-blue);
}

.mes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mes-titulo {
    font-weight: 600;
    font-size: 14px;
}

.mes-info {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.mes-badge {
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    background: rgba(5, 150, 105, 0.2);
    color: var(--accent-green);
}

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* Splash Screen Styles */
.splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: fadeOutSplash 0.5s ease 2.5s forwards;
}

.splash-screen.hidden {
    display: none;
}

.splash-logo {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, var(--accent-blue), #06b6d4);
    border-radius: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    margin-bottom: 30px;
    animation: splashBounce 0.8s ease-in-out infinite;
    box-shadow: 0 20px 60px rgba(37, 99, 235, 0.3);
}

.splash-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 10px;
    text-align: center;
    background: linear-gradient(90deg, var(--accent-blue), #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.splash-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 40px;
}

.splash-loader {
    width: 50px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
}

.splash-loader::after {
    content: "";
    display: block;
    width: 20px;
    height: 100%;
    background: linear-gradient(90deg, var(--accent-blue), #06b6d4);
    border-radius: 2px;
    animation: splashLoading 1.5s ease-in-out infinite;
}

@keyframes splashBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

@keyframes splashLoading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(150px); }
}

@keyframes fadeOutSplash {
    to {
        opacity: 0;
        visibility: hidden;
    }
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splashScreen" class="splash-screen">
    <div class="splash-logo">üí∞</div>
    <div class="splash-title">Nosdu</div>
    <div class="splash-subtitle">Controle Financeiro</div>
    <div class="splash-loader"></div>
</div>

<div class="preview-container">
    
    <!-- Permission Modal -->
    <div id="permissionModal" class="permission-overlay">
        <div class="permission-modal">
            <div class="permission-icon">üíæ</div>
            <h2 class="permission-title">Permiss√£o de Armazenamento</h2>
            <p class="permission-text">
                O Nosdu precisa salvar seus dados financeiros no armazenamento do dispositivo para mant√™-los seguros.
            </p>
            <div class="permission-features">
                <div class="permission-feature">
                    <i>‚úì</i> Dados salvos localmente no dispositivo
                </div>
                <div class="permission-feature">
                    <i>‚úì</i> Acesso offline completo
                </div>
                <div class="permission-feature">
                    <i>‚úì</i> Backup autom√°tico mensal
                </div>
                <div class="permission-feature">
                    <i>‚úì</i> Prote√ß√£o contra perda de dados
                </div>
            </div>
            <div class="permission-buttons">
                <button class="permission-btn primary" onclick="grantPermission()">
                    Permitir Acesso ao Armazenamento
                </button>
                <button class="permission-btn secondary" onclick="denyPermission()">
                    Usar Modo Tempor√°rio
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o para Zerar -->
    <div id="confirmZerarModal" class="confirm-modal">
        <div class="confirm-box">
            <h3 class="confirm-title">‚ö†Ô∏è ZERAR TODOS OS DADOS</h3>
            <p class="confirm-text">
                Esta a√ß√£o apagar√° permanentemente todos os dados financeiros salvos.<br><br>
                Digite <strong>SIM</strong> para confirmar:
            </p>
            <input type="text" id="confirmZerarInput" class="confirm-input" placeholder="Digite SIM" autocomplete="off">
            <div class="confirm-buttons">
                <button class="confirm-btn secondary" onclick="fecharConfirmZerar()">Cancelar</button>
                <button class="confirm-btn danger" id="btnConfirmZerar" onclick="executarZerar()" disabled>Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <h1>Nosdu Controle Financeiro</h1>
        <span>v2.0 - Armazenamento Nativo</span>
        <button id="installBtn" class="install-btn" style="display: none;" onclick="installApp()">
            üì≤ Instalar
        </button>
    </header>

    <!-- Main Content -->
    <main>
        
        <!-- Entradas -->
        <section id="entradas" class="active">
            <div class="card">
                <h3 class="card-title">üí∞ Nova Entrada</h3>
                <input type="number" id="entradaValor" placeholder="Valor (R$)" step="0.01">
                <select id="entradaCategoria" onchange="toggleDescricao('entrada')">
                    <option value="">Selecione a categoria</option>
                    <option>Shopee Sal√°rio</option>
                    <option>Lalamove Sal√°rio</option>
                    <option>Outros Recebimentos</option>
                </select>
                <div id="entradaDescContainer" class="descricao-field">
                    <input type="text" id="entradaDesc" placeholder="Descri√ß√£o detalhada">
                </div>
                <button class="action" onclick="addEntrada()">Adicionar Entrada</button>
            </div>
            <div id="listaEntradas"></div>
        </section>

        <!-- Sa√≠das -->
        <section id="saidas">
            <div class="card">
                <h3 class="card-title">üí∏ Nova Sa√≠da</h3>
                <input type="number" id="saidaValor" placeholder="Valor (R$)" step="0.01">
                <select id="saidaCategoria" onchange="toggleDescricao('saida')">
                    <option value="">Selecione a categoria</option>
                    <option>Conta de casa</option>
                    <option>Mercado</option>
                    <option>Lanches</option>
                    <option>Manuten√ß√£o do carro</option>
                    <option>Combust√≠vel</option>
                    <option>Outros gastos</option>
                </select>
                <div id="saidaDescContainer" class="descricao-field">
                    <input type="text" id="saidaDesc" placeholder="Descri√ß√£o detalhada">
                </div>
                <button class="action" onclick="addSaida()">Adicionar Sa√≠da</button>
            </div>
            <div id="listaSaidas"></div>
        </section>

        <!-- Relat√≥rios -->
        <section id="relatorios">
            <div class="card">
                <h3 class="card-title">üìä Resumo do M√™s</h3>
                <div id="resumoMensal"></div>
            </div>

            <div class="card">
                <h3 class="card-title">üìà Entradas por Categoria</h3>
                <div id="graficoEntradas" class="chart-container"></div>
            </div>

            <div class="card">
                <h3 class="card-title">üìâ Sa√≠das por Categoria</h3>
                <div id="graficoSaidas" class="chart-container"></div>
            </div>

            <div class="card">
                <h3 class="card-title">‚è∞ Timeline</h3>
                <div id="timeline" class="timeline"></div>
            </div>
        </section>

        <!-- Sistema -->
        <section id="sistema">
            <div class="card">
                <h3 class="card-title">üíæ Backup e Restaura√ß√£o</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                    Exporte seus dados para um arquivo seguro ou restaure de um backup anterior.
                </p>
                <div class="backup-section">
                    <button class="backup-btn" onclick="exportarBackup()">
                        <span>üíæ</span> Exportar Backup para Arquivo
                    </button>
                    <button class="backup-btn" onclick="importarBackup()">
                        <span>üìÇ</span> Restaurar de Arquivo
                    </button>
                    <input type="file" id="importFile" style="display:none;" accept=".json,.ncf" onchange="processarImportacao(this)">
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìÇ Meses Anteriores</h3>
                <div id="mesesAnteriores"></div>
            </div>

            <div class="card">
                <h3 class="card-title">‚ö†Ô∏è Zona de Perigo</h3>
                <button class="backup-btn" style="border-color: var(--accent-red); color: var(--accent-red);" onclick="abrirConfirmZerar()">
                    <span>üóëÔ∏è</span> Zerar Todos os Dados
                </button>
            </div>
        </section>

    </main>

    <!-- Navigation -->
    <nav>
        <button class="active" onclick="showTab('entradas', this)">
            <span>üí∞</span>
            Entradas
        </button>
        <button onclick="showTab('saidas', this)">
            <span>üí∏</span>
            Sa√≠das
        </button>
        <button onclick="showTab('relatorios', this)">
            <span>üìä</span>
            Relat√≥rios
        </button>
        <button onclick="showTab('sistema', this)">
            <span>‚öôÔ∏è</span>
            Sistema
        </button>
    </nav>

</div>

<script>
// ==========================================
// NOSDU FINANCEIRO - SISTEMA COMPLETO
// ==========================================

// PWA INSTALLATION HANDLER
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBtn = document.getElementById('installBtn');
    if (installBtn) {
        installBtn.style.display = 'block';
    }
});

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                showNotification('App instalado com sucesso!');
            }
            deferredPrompt = null;
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.style.display = 'none';
            }
        });
    } else {
        showNotification('App ja esta instalado ou nao disponivel', 'warning');
    }
}

window.addEventListener('appinstalled', () => {
    const installBtn = document.getElementById('installBtn');
    if (installBtn) {
        installBtn.style.display = 'none';
    }
    showNotification('Nosdu adicionado a tela inicial!');
});

// Splash Screen Handler
function hideSplashScreen() {
    const splash = document.getElementById('splashScreen');
    if (splash) {
        setTimeout(() => {
            splash.classList.add('hidden');
        }, 2500);
    }
}

carregarDados();

// Hide splash screen after app loads
window.addEventListener('load', hideSplashScreen);

const state = {
    storageGranted: false,
    dados: {
        entradas: [],
        saidas: [],
        mesReferencia: new Date().toISOString().slice(0, 7),
        historicoMensal: []
    },
    db: null
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    initApp();
    
    // Monitorar input de confirma√ß√£o
    document.getElementById('confirmZerarInput').addEventListener('input', function() {
        const btn = document.getElementById('btnConfirmZerar');
        btn.disabled = this.value.trim().toUpperCase() !== 'SIM';
    });
});

// Inicializa√ß√£o do app com verifica√ß√£o de primeira vez
async function initApp() {
    try {
        // Tentar abrir o banco de dados
        await openDatabase();
        
        // Verificar se j√° existe dados ou se √© primeira vez
        const existingData = await loadData();
        
        // Verificar no localStorage se j√° viu o modal (fallback)
        let hasSeenModal = false;
        try {
            hasSeenModal = localStorage.getItem('nosdu_permission_seen') === 'true';
        } catch (e) {
            console.log('localStorage n√£o dispon√≠vel');
        }
        
        if (existingData || hasSeenModal) {
            // J√° tem dados ou j√° viu o modal antes
            if (existingData) {
                state.dados = existingData;
            }
            state.storageGranted = true;
            hidePermissionModal();
            render();
        } else {
            // Primeira vez - mostrar modal
            showPermissionModal();
        }
    } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        // Em caso de erro, mostrar modal para garantir
        showPermissionModal();
    }
}

function salvarDados() {
  localStorage.setItem(
    'nosdu_dados',
    JSON.stringify(state.dados)
  );
}

function carregarDados() {
  const dadosSalvos = localStorage.getItem('nosdu_dados');

  if (dadosSalvos) {
    state.dados = JSON.parse(dadosSalvos);
  }
}


// Mostrar modal de permiss√£o
function showPermissionModal() {
    const modal = document.getElementById('permissionModal');
    modal.classList.add('active');
}

// Esconder modal de permiss√£o
function hidePermissionModal() {
    const modal = document.getElementById('permissionModal');
    modal.classList.remove('active');
}

// IndexedDB
function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('NosduDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            state.db = request.result;
            resolve(state.db);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('dados')) {
                db.createObjectStore('dados', { keyPath: 'id' });
            }
        };
    });
}

async function saveData() {
    if (!state.db) await openDatabase();
    
    return new Promise((resolve, reject) => {
        const transaction = state.db.transaction(['dados'], 'readwrite');
        const store = transaction.objectStore('dados');
        
        const dataToSave = {
            id: 'principal',
            ...state.dados,
            lastUpdate: new Date().toISOString()
        };
        
        const request = store.put(dataToSave);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

async function loadData() {
    if (!state.db) await openDatabase();
    
    return new Promise((resolve, reject) => {
        const transaction = state.db.transaction(['dados'], 'readonly');
        const store = transaction.objectStore('dados');
        const request = store.get('principal');
        
        request.onsuccess = () => {
            if (request.result) {
                resolve(request.result);
            } else {
                resolve(null);
            }
        };
        request.onerror = () => reject(request.error);
    });
}

// Interface de Permiss√£o
function grantPermission() {
    state.storageGranted = true;
    hidePermissionModal();
    
    // Marcar que j√° viu o modal (tanto no localStorage quanto no IndexedDB)
    marcarModalComoVisto();
    
    showNotification('‚úì Permiss√£o concedida! Dados ser√£o salvos no dispositivo.');
    
    if (navigator.storage && navigator.storage.persist) {
        navigator.storage.persist().then(granted => {
            if (granted) console.log('Storage persistente concedido');
        });
    }
    
    // Iniciar zerado
    saveData().then(() => render());
}

function denyPermission() {
    hidePermissionModal();
    
    // Marcar que j√° viu o modal mesmo negando
    marcarModalComoVisto();
    
    showNotification('‚ö†Ô∏è Modo tempor√°rio ativado.', 'warning');
    state.storageGranted = true;
    
    // Iniciar zerado
    render();
}

// Marcar que j√° viu o modal (usando ambos os m√©todos para garantir)
function marcarModalComoVisto() {
    try {
        localStorage.setItem('nosdu_permission_seen', 'true');
    } catch (e) {
        console.log('localStorage n√£o dispon√≠vel');
    }
    
    // Tamb√©m salvar no IndexedDB como backup
    if (state.db) {
        const transaction = state.db.transaction(['dados'], 'readwrite');
        const store = transaction.objectStore('dados');
        store.put({
            id: 'config',
            permissionSeen: true,
            timestamp: new Date().toISOString()
        });
    }
}

// Notifica√ß√µes
function showNotification(message, type = 'success') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'slideDown 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

// Toggle descri√ß√£o
function toggleDescricao(tipo) {
    const categoria = document.getElementById(`${tipo}Categoria`).value;
    const container = document.getElementById(`${tipo}DescContainer`);
    
    const ehOutros = categoria.toLowerCase().includes('outros');
    
    if (ehOutros) {
        container.classList.add('visible');
    } else {
        container.classList.remove('visible');
        document.getElementById(`${tipo}Desc`).value = '';
    }
}

// Navega√ß√£o
function showTab(tabId, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    render();
}

// Opera√ß√µes CRUD
function addEntrada() {
    const valor = parseFloat(document.getElementById('entradaValor').value);
    const cat = document.getElementById('entradaCategoria').value;
    const desc = document.getElementById('entradaDesc').value;
    
    if (!valor || !cat) {
        showNotification('Preencha valor e categoria', 'error');
        return;
    }
    
    const ehOutros = cat.toLowerCase().includes('outros');
    const descFinal = ehOutros ? desc : '';
    
    const agora = new Date();
    state.dados.entradas.push({
        id: Date.now(),
        valor,
        desc: descFinal,
        cat,
        data: agora.toISOString().split('T')[0],
        hora: agora.toTimeString().slice(0, 5),
        timestamp: agora.getTime()
    });
    
    saveData().then(() => {
        showNotification('‚úì Entrada adicionada');
        document.getElementById('entradaValor').value = '';
        document.getElementById('entradaCategoria').value = '';
        document.getElementById('entradaDesc').value = '';
        document.getElementById('entradaDescContainer').classList.remove('visible');
        render();
    });
}

function addSaida() {
    const valor = parseFloat(document.getElementById('saidaValor').value);
    const cat = document.getElementById('saidaCategoria').value;
    const desc = document.getElementById('saidaDesc').value;
    
    if (!valor || !cat) {
        showNotification('Preencha valor e categoria', 'error');
        return;
    }
    
    const ehOutros = cat.toLowerCase().includes('outros');
    const descFinal = ehOutros ? desc : '';
    
    const agora = new Date();
    state.dados.saidas.push({
        id: Date.now(),
        valor,
        desc: descFinal,
        cat,
        data: agora.toISOString().split('T')[0],
        hora: agora.toTimeString().slice(0, 5),
        timestamp: agora.getTime()
    });
    
    saveData().then(() => {
        showNotification('‚úì Sa√≠da adicionada');
        document.getElementById('saidaValor').value = '';
        document.getElementById('saidaCategoria').value = '';
        document.getElementById('saidaDesc').value = '';
        document.getElementById('saidaDescContainer').classList.remove('visible');
        render();
    });
}

function deleteEntrada(id) {
    state.dados.entradas = state.dados.entradas.filter(e => e.id !== id);
    saveData().then(() => {
        showNotification('Entrada removida');
        render();
    });
}

function deleteSaida(id) {
    state.dados.saidas = state.dados.saidas.filter(s => s.id !== id);
    saveData().then(() => {
        showNotification('Sa√≠da removida');
        render();
    });
}

// Renderiza√ß√£o
function render() {
    renderEntradas();
    renderSaidas();
    renderResumo();
    renderGraficos();
    renderTimeline();
    renderMesesAnteriores();
}

function renderEntradas() {
    const container = document.getElementById('listaEntradas');
    if (!container) return;
    
    const items = state.dados.entradas.slice().reverse();
    container.innerHTML = items.map(e => `
        <div class="list-item entrada">
            <div class="list-item-info">
                <div class="list-item-value positive">+ R$ ${formatMoney(e.valor)}</div>
                <div class="list-item-meta">${e.cat} ‚Ä¢ ${e.data} ${e.hora}</div>
                ${e.desc ? `<div class="list-item-desc">"${e.desc}"</div>` : ''}
            </div>
            <button class="list-item-delete" onclick="deleteEntrada(${e.id})">√ó</button>
        </div>
    `).join('') || '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Nenhuma entrada</p>';
}

function renderSaidas() {
    const container = document.getElementById('listaSaidas');
    if (!container) return;
    
    const items = state.dados.saidas.slice().reverse();
    container.innerHTML = items.map(s => `
        <div class="list-item saida">
            <div class="list-item-info">
                <div class="list-item-value negative">- R$ ${formatMoney(s.valor)}</div>
                <div class="list-item-meta">${s.cat} ‚Ä¢ ${s.data} ${s.hora}</div>
                ${s.desc ? `<div class="list-item-desc">"${s.desc}"</div>` : ''}
            </div>
            <button class="list-item-delete" onclick="deleteSaida(${s.id})">√ó</button>
        </div>
    `).join('') || '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Nenhuma sa√≠da</p>';
}

function renderResumo() {
    const container = document.getElementById('resumoMensal');
    if (!container) return;
    
    const totalEntradas = state.dados.entradas.reduce((a, b) => a + b.valor, 0);
    const totalSaidas = state.dados.saidas.reduce((a, b) => a + b.valor, 0);
    const saldo = totalEntradas - totalSaidas;
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Entradas</div>
                <div style="font-size: 20px; font-weight: 700; color: var(--accent-green);">R$ ${formatMoney(totalEntradas)}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Sa√≠das</div>
                <div style="font-size: 20px; font-weight: 700; color: var(--accent-red);">R$ ${formatMoney(totalSaidas)}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">Saldo</div>
                <div style="font-size: 20px; font-weight: 700; color: ${saldo >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">R$ ${formatMoney(saldo)}</div>
            </div>
        </div>
    `;
}

function renderGraficos() {
    renderGrafico('graficoEntradas', state.dados.entradas, 'entrada');
    renderGrafico('graficoSaidas', state.dados.saidas, 'saida');
}

function renderGrafico(containerId, items, tipo) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const agrupado = {};
    items.forEach(i => {
        agrupado[i.cat] = (agrupado[i.cat] || 0) + i.valor;
    });
    
    const total = Object.values(agrupado).reduce((a, b) => a + b, 0);
    const sorted = Object.entries(agrupado).sort((a, b) => b[1] - a[1]);
    
    container.innerHTML = sorted.map(([cat, valor]) => {
        const pct = total > 0 ? (valor / total * 100) : 0;
        return `
            <div class="chart-bar">
                <div class="chart-bar-header">
                    <span>${cat}</span>
                    <span>R$ ${formatMoney(valor)} (${pct.toFixed(1)}%)</span>
                </div>
                <div class="chart-bar-track">
                    <div class="chart-bar-fill ${tipo}" style="width: ${pct}%"></div>
                </div>
            </div>
        `;
    }).join('') || '<p style="color: var(--text-secondary); font-size: 12px;">Sem dados</p>';
}

function renderTimeline() {
    const container = document.getElementById('timeline');
    if (!container) return;
    
    const todos = [
        ...state.dados.entradas.map(e => ({...e, tipo: 'entrada'})),
        ...state.dados.saidas.map(s => ({...s, tipo: 'saida'}))
    ].sort((a, b) => b.timestamp - a.timestamp).slice(0, 10);
    
    container.innerHTML = todos.map(item => `
        <div class="timeline-item ${item.tipo}">
            <div class="timeline-content">
                <div class="timeline-time">${item.data} ${item.hora}</div>
                <div class="timeline-value" style="color: ${item.tipo === 'entrada' ? 'var(--accent-green)' : 'var(--accent-red)'}">
                    ${item.tipo === 'entrada' ? '+' : '-'} R$ ${formatMoney(item.valor)}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">${item.cat}</div>
                ${item.desc ? `<div class="timeline-desc">"${item.desc}"</div>` : ''}
            </div>
        </div>
    `).join('') || '<p style="color: var(--text-secondary); text-align: center;">Nenhuma movimenta√ß√£o</p>';
}

function renderMesesAnteriores() {
    const container = document.getElementById('mesesAnteriores');
    if (!container) return;
    
    const meses = state.dados.historicoMensal || [];
    if (meses.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Nenhum m√™s fechado ainda</p>';
        return;
    }
    
    container.innerHTML = meses.map(mes => `
        <div class="mes-item">
            <div class="mes-header">
                <div>
                    <div class="mes-titulo">${mes.nomeMes}</div>
                    <div class="mes-info">Saldo: R$ ${formatMoney(mes.saldo)} ‚Ä¢ ${mes.totalRegistros} registros</div>
                </div>
                <span class="mes-badge">‚úì Fechado</span>
            </div>
        </div>
    `).join('');
}

// Backup
function exportarBackup() {
    const dataStr = JSON.stringify(state.dados, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `Nosdu_Backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('‚úì Backup exportado!');
}

function importarBackup() {
    document.getElementById('importFile').click();
}

function processarImportacao(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (confirm('Restaurar backup? Isso substituir√° os dados atuais.')) {
                state.dados = data;
                saveData().then(() => {
                    showNotification('‚úì Backup restaurado!');
                    render();
                });
            }
        } catch (err) {
            showNotification('Erro ao ler arquivo', 'error');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// Zerar Sistema
function abrirConfirmZerar() {
    document.getElementById('confirmZerarModal').classList.add('active');
    document.getElementById('confirmZerarInput').value = '';
    document.getElementById('btnConfirmZerar').disabled = true;
    document.getElementById('confirmZerarInput').focus();
}

function fecharConfirmZerar() {
    document.getElementById('confirmZerarModal').classList.remove('active');
}

function executarZerar() {
    const input = document.getElementById('confirmZerarInput');
    if (input.value.trim().toUpperCase() !== 'SIM') {
        showNotification('Digite SIM para confirmar', 'error');
        return;
    }
    
    state.dados = {
        entradas: [],
        saidas: [],
        mesReferencia: new Date().toISOString().slice(0, 7),
        historicoMensal: []
    };
    
    if (state.db) {
        const transaction = state.db.transaction(['dados'], 'readwrite');
        const store = transaction.objectStore('dados');
        store.delete('principal');
    }
    
    fecharConfirmZerar();
    showNotification('Sistema zerado completamente');
    render();
}

// Utilit√°rios
function formatMoney(value) {
    return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}

</script>

</body>
</html>
